# 第2章：命令和工具  
## 一、基本命令  

### 1. `man`：查阅联机手册  

根据PPT内容，`man` 命令是 Linux 系统中用于查阅联机手册（manual）的核心工具。其功能不仅限于查看命令用法，还覆盖了系统开发与管理的多个层面：

- **功能**：  
  - 提供各类技术文档的在线查阅，包括：
    - 各种命令的使用说明书  
    - 系统调用（system calls）的接口说明  
    - C语言及其他编程语言的标准库函数手册  
    - 系统配置文件的格式规范  

- **命名来源**：  
  - “man” 取自英文单词 *manual* 的前三个字母，体现了其作为“手册”的核心用途。

- **常用用法**（PPT明确列出）：  
  - `man name`：直接查看指定名称的手册页（如 `man date`）  
  - `man section name`：在指定章节中查找（例如 `man 2 open` 查看系统调用 `open`）  
    - 章节编号含义如下（PPT强调）：
      - **1**：用户可执行命令（如 `ls`, `date`）  
      - **2**：系统调用（由内核提供，如 `fork`, `read`）  
      - **3**：C 库函数（如 `printf`, `malloc`）  
      - **5**：配置文件格式（如 `/etc/passwd` 的结构说明）  
  - `man -k regexp`：通过关键字（支持正则表达式）搜索相关手册条目（等价于 `apropos`）

- **手册页内容结构**（PPT详细说明）：  
  - 清晰列出命令或函数的基本功能、语法格式  
  - 对于 C 语言函数，会注明所需包含的头文件（如 `#include <stdio.h>`）及链接时需指定的库（如 `-lm`）  
  - 包含 **SEE ALSO** 部分，列出相关命令或函数及其所属章节，便于知识拓展

- **操作方式（分页器）**：  
  - 手册内容通常较长，系统自动调用分页器（如 `less`）显示  
  - PPT指出常用操作键：
    - `q`：退出手册  
    - 空格键：翻到下一页  
    - 上/下方向键：逐行滚动  

---

### 2. `date`：显示/设置系统日期和时间  

PPT将 `date` 定位为读取和格式化系统时间的基础命令，并提供了具体示例与高级用法：

- **基本用法**：  
  - 执行 `date` 即可显示当前系统日期和时间，格式如：  
    `Wed Nov 7 21:09:16 CST 2018`

- **自定义格式输出**：  
  - 使用以 `+` 开头的格式控制字符串，例如：  
    ```bash
    date "+%Y-%m-%d %H:%M:%S Day%j"
    ```
    输出结果为：`2018-11-07 21:09:54 Day 311`  
    其中 `Day 311` 表示该日是当年的第 311 天  
  - `date "+%s"` 输出 Unix 时间戳（秒数），常用于脚本中计算时间间隔

- **常用格式符**（PPT明确解释）：  
  - `%Y`：四位年份（如 2018）  
  - `%m`：两位月份（01–12）  
  - `%M`：两位分钟（00–59）——注意与 `%m` 区分  
  - `%j`：一年中的第几天（001–366）

- **时间同步（NTP）**：  
  - PPT特别提到可通过 `ntpdate` 命令校准系统时间：  
    - `ntpdate 0.pool.ntp.org`：**需 root 权限**，直接设置系统时间  
    - `ntpdate -q 0.pool.ntp.org`：仅查询时间服务器时间，**普通用户也可执行**，不修改本地时间  

> PPT建议：对于复杂选项和格式，应通过 `man date` 查阅完整手册。

---

### 3. `cal`：打印日历  

PPT对 `cal` 命令的介绍简洁但全面，强调其多参数灵活性：

- **基本用法**：  
  - `cal`：显示当前月份的日历（默认行为）  
  - `cal year`：显示指定年份的全年日历（如 `cal 2020`）  
  - `cal month year`：显示某年某月的日历（如 `cal 10 2019` 显示 2019 年 10 月）

- **注意事项**：  
  - PPT特别举例指出：`cal 12` 并非指 2012 年，而是**公元 12 年**，说明该命令接受纯年份数字，无默认世纪补全逻辑。

---

### 4. `bc`：计算器  

PPT将 `bc` 描述为一个功能远超普通计算器的工具，具备编程能力：

- **功能特点**：  
  - 不仅支持基本四则运算，还支持：
    - 变量赋值（如 `x = 5`）  
    - 自定义函数  
    - 条件语句（`if`）与循环（`while`）  
    - 类似 C 语言的语法结构，可视为一种小型脚本语言  
  - 支持**任意精度**浮点运算（不受硬件限制）

- **精度控制**：  
  - 默认情况下（不带 `-l`），`bc` 的小数精度为 **0 位**（即整数运算）  
  - 使用 `bc -l` 启动时，默认精度提升至 **20 位小数**，并加载数学函数库  
  - 用户可通过内置变量 `scale` 动态设置精度，例如：  
    ```bash
    scale=10000
    ```
    表示后续计算保留 10000 位小数

- **示例说明**：  
  - PPT举例 `s(1.0)` 表示计算 sin(1.0)（弧度制）  
  - 但强调：此类数学函数**必须使用 `-l` 选项**才能启用，否则会报错

---

### 5. `passwd`：修改用户口令  

PPT从权限角度清晰区分了普通用户与超级用户的操作差异，并强调安全机制：

- **普通用户行为**：  
  - 只能修改**自己的密码**  
  - 修改前**必须验证旧密码**，防止未授权更改

- **超级用户（root）特权**：  
  - **无需输入旧密码**即可修改任何账户的密码  
  - 可通过 `passwd username`（如 `passwd liu`）**强制重置他人密码**  
  - **无法读取其他用户的明文密码**（因密码以哈希形式存储）  
  - 当普通用户忘记密码时，可请求 root 执行强设操作

- **安全提示**：  
  - PPT特别警告：“修改超级用户 root 的口令时，请格外注意”  
  - 暗示 root 密码一旦丢失或泄露，将导致系统完全失控

---

## 二、系统状态查看工具  

### 1. `who`：查看当前已登录用户  

根据PPT内容，`who` 命令用于列出当前登录到系统的用户会话信息。其输出结构清晰，包含关键的身份与会话上下文：

- **输出格式**：  
  - 每行显示三项信息：**用户名**、**终端设备名**、**登录时间**  
  - 示例（PPT原文）：  
    ```
    wujian tty00 Jul 5 14:49
    sun    tty01 Jul 5 11:31
    liang  ttyp02 Jul 5 15:50
    ```  
    表明三位用户分别从不同终端在7月5日的不同时间登录。

- **相关命令对比**（PPT特别区分）：  
  - `who am i`：仅显示**当前终端**对应的登录记录（包括用户名、终端、时间），常用于脚本中确认当前会话身份  
  - `whoami`：更精简，**只输出当前有效用户名**，不包含终端或时间信息，适用于权限检查等场景

- **终端设备文件说明**：  
  - PPT指出，每个终端在 Linux 中以**特殊设备文件**形式存在，统一存放于 `/dev` 目录下  
  - 例如 `tty00` 对应的设备路径为 `/dev/tty00`  
  - 用户可通过 `tty` 命令直接打印当前终端的设备文件名，辅助调试多终端环境

> PPT强调：理解终端设备机制有助于分析多用户并发、远程登录（如 SSH）及会话管理问题。

---

### 2. `uptime`：查看系统运行状态  

PPT将 `uptime` 描述为快速获取系统整体运行概况的“健康快照”命令：

- **显示内容**（按顺序解析）：  
  - **当前系统时间**（如 `21:32:56`）  
  - **系统连续运行时长**（如 `up 412 days, 4:15`），反映系统稳定性  
  - **当前登录用户数量**（如 `5 users`）  
  - **系统负载平均值**（Load Average）：分别表示过去 **1分钟、5分钟、15分钟** 内的平均负载  

- **负载含义详解**（PPT明确解释）：  
  - 负载 = **CPU调度队列中的平均进程数**（包括正在运行和等待 CPU 的进程）  
  - 并非 CPU 使用率；即使 CPU 空闲，若存在大量 I/O 阻塞进程（如磁盘读写等待），负载也可能很高  
  - 示例输出：`load average: 0.55, 0.73, 0.43` 表示系统负载较低，运行平稳

> PPT提示：`uptime` 是日常运维第一响应命令，可快速判断系统是否异常繁忙或长时间未重启。

---

### 3. `top`：动态查看高资源占用进程  

PPT将 `top` 定位为实时监控系统资源消耗的核心交互式工具，强调其动态性和字段含义：

- **主要字段含义**（PPT逐项说明）：  
  - `VIRT`（Virtual Memory Size）：进程使用的**虚拟地址空间总大小**，包括共享库、内存映射文件等  
  - `RES`（Resident Set Size）：进程实际驻留在**物理内存中的字节数**（即真实内存占用）  
  - `SHR`：`RES` 中可被其他进程共享的部分（如 C 库、共享内存段）  
  - `%CPU` / `%MEM`：该进程占用的 **CPU 时间百分比** 和 **物理内存百分比**（基于总内存）  
  - `TIME+`：自进程启动以来累计消耗的 **CPU 时间**，精确到百分之一秒（如 `12:34.56`）

- **交互特性**：  
  - 默认**每秒自动刷新**一次，持续更新进程列表  
  - **默认按 `%CPU` 降序排序**，便于第一时间发现资源“大户”  
  - 支持交互操作（如按 `q` 退出、`k` 终止进程），但 PPT未深入，仅强调其实时监控价值

> PPT建议：当系统响应变慢时，优先运行 `top` 判断是否由某进程异常占用 CPU 或内存引起。

---

### 4. `ps`：查看进程状态（静态快照）  

与 `top` 的动态性不同，PPT强调 `ps` 提供的是**某一时刻的进程静态快照**，适合脚本处理或一次性诊断：

- **常用选项**（PPT明确列出）：  
  - **无选项**：仅显示**当前终端启动的进程**（范围有限）  
  - `-e`：列出**系统中所有进程**（等价于 `ps aux` 中的 `a` + `x`）  
  - `-f`：以 **full 格式** 显示，增加 UID、PPID、完整启动时间等列  
  - `-l`：以 **long 格式** 显示，侧重调度细节（如优先级、WCHAN）

- **关键字段说明**（PPT逐一解释）：  
  - `PID`：进程唯一标识号（Process ID）  
  - `PPID`：父进程 ID，用于构建进程父子关系树  
  - `UID`：启动该进程的用户 ID（可显示为用户名）  
  - `TTY`：控制终端名称（若为 `?` 表示无关联终端，常见于守护进程）  
  - `COMMAND`：启动该进程的完整命令行（含参数）  
  - `TIME`：该进程自启动以来累计使用的 **CPU 时间**  
  - `S`（进程状态）：
    - `R`：Running（正在运行或处于可运行队列）  
    - `S`：Sleeping（可中断睡眠，等待事件如 I/O 完成）  
    - `Z`：Zombie（僵尸进程，已终止但未被父进程回收）  
  - `PRI`：内核调度优先级（数值越小优先级越高）  
  - `WCHAN`：若进程处于睡眠状态，显示其在内核中**等待的通道名称**（用于内核调试）

> PPT指出：`ps` 输出稳定、格式固定，是编写自动化监控脚本的基础命令。

---

### 5. `free`：查看内存使用情况  

PPT通过 `free` 命令揭示了 Linux 内存管理的核心理念——“缓存即可用”，并澄清常见误解：

- **输出字段解析**（基于 PPT 示例）：  
  ```
  total     used     free   shared buff/cache available
  Mem:   1024136    75196    77304    11056     871636      735468
  Swap:        0        0        0
  ```  
  - `total` / `used` / `free`：物理内存总量、已用、完全空闲部分（单位 KB）  
  - `shared`：被多个进程共享的内存（如 tmpfs、POSIX 共享内存）  
  - `buff/cache`：Linux 为提升 I/O 性能而自动使用的**缓冲区（buffer）与页缓存（cache）**  
    - 这部分内存**可被应用程序随时回收**，不应视为“已占用”  
  - `available`：**估算的实际可用内存** = free + 可回收的 cache/buffer，是判断内存是否紧张的关键指标

- **Swap 分区状态**：  
  - 单独一行显示交换空间（swap）的使用情况  
  - 示例中 `Swap: 0 0 0` 表示未配置 swap 分区  
  - 若 `used` > 0，表明物理内存不足，系统正使用磁盘交换，性能将显著下降

> PPT提醒：不要仅看 `used` 判断内存压力，应重点关注 `available` 字段。

---

### 6. `vmstat`：综合监控系统负载  

PPT将 `vmstat` 定义为轻量级但全面的系统性能采样工具，适合长期监控与瓶颈分析：

- **报告字段分类详解**（PPT逐类说明）：  

  - **Procs（进程状态）**：  
    - `r`：**等待运行的进程数**（位于 CPU 调度队列中），若持续大于 CPU 核心数，表明 CPU 瓶颈  
    - `b`：**处于不可中断睡眠状态的进程数**（通常因等待磁盘或网络 I/O），过高可能表示 I/O 阻塞  

  - **Memory（内存，单位 KB）**：  
    - `free`：完全空闲的物理内存  
    - `buff`：用于块设备 I/O 的缓冲区（如写入磁盘前的临时存储）  
    - `cache`：用于文件系统缓存的页缓存（如读取过的文件内容）  

  - **Swap（交换活动）**：  
    - `si`（swap in）：每秒从 swap **换入**物理内存的数据量（KB/s）  
    - `so`（swap out）：每秒从物理内存**换出**到 swap 的数据量（KB/s）  
    - 若 `si`/`so` 持续 > 0，说明内存严重不足  

  - **IO（块设备 I/O）**：  
    - `bi`（blocks in）：每秒从块设备（如硬盘）**读取**的块数  
    - `bo`（blocks out）：每秒向块设备**写入**的块数  

  - **System（系统活动）**：  
    - `in`：每秒发生的**硬件中断次数**（包括时钟、键盘、网卡等）  
    - `cs`：每秒发生的**上下文切换次数**（进程或线程切换开销，过高影响性能）  

  - **CPU（时间分配百分比）**：  
    - `us`：用户态程序（如应用程序）占用的 CPU 时间  
    - `sy`：内核态（系统调用、中断处理等）占用的 CPU 时间  
    - `id`：CPU **空闲时间**，理想情况下应较高  
    - `wa`：CPU **等待 I/O 完成**的时间比例，高 `wa`（如 >20%）强烈暗示磁盘或存储瓶颈  

> PPT总结：`vmstat` 输出紧凑、开销低，适合配合 `watch vmstat 1` 或日志脚本进行性能基线采集与异常检测。

---